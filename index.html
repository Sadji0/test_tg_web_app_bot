<!DOCTYPE html>
<html class="light" style="--tg-viewport-height:100vh; --tg-viewport-stable-height:100vh;">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="MobileOptimized" content="176">
  <meta name="HandheldFriendly" content="True">
  <meta name="robots" content="noindex,nofollow">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="css/styles.css">
  <script>
    function setThemeClass() {
      document.documentElement.className = Telegram.WebApp.colorScheme;
    }
    Telegram.WebApp.onEvent('themeChanged', setThemeClass);
    setThemeClass();
  </script>

</head>

<body style="">
  <section>
    <h1 id="hello_message">Привет, Имя</h1>

    <div id="data_btn">
      <h3>Твой счет: 0 кат</h3>
      <h4>Что бы вы хотели сделать?</h4>
      <textarea class="text_field" rows="4"></textarea>
      <button onclick="sendText(true);">Отправить своё сообщение (10 кат)</button>
      <button onclick="sendHello();">Отправить приветствие (5 кат)</button>
      <button onclick="sendTestMessage();">Отправить тестовое сообщение</button>
      <button onclick="sendTime();">Отправка текущего времени (5 кат)</button>
    </div>
    <button onclick="toggleMainButton(this);">Скрыть главную кнопку</button>
    <div id="btn_status" class="hint" style="display: none;">
    </div>
    <p>Тестовые ссылки:</p>
    <ul>
      <!-- <li><a id="regular_link" href="https://webappcontent.telegram.org/demo?nextpage=1">Regular link #1</a> (opens inside webview)</li> -->
      <li><a href="https://t.me/mihail_plavko" target="_blank">открыть личные сообщения</a></li>
    </ul>
    <p>Тесты на разрешение:</p>
    <ul>
      <li><a href="javascript:;" onclick="return requestLocation(this);">Request Location</a> <span></span></li>
      <li><a href="javascript:;" onclick="return requestVideo(this);">Request Video</a> <span></span></li>
    </ul>
    
  </section>
  <!-- <div class="viewport_border" text="1536 x 711"></div> -->
  <!-- <div class="viewport_stable_border" text="1536 x 711 | is_expanded: true"></div> -->

  <script src="js/jquery.min.js"></script>
  <script>
    Telegram.WebApp.ready();

    var initData = Telegram.WebApp.initData || '';
    var initDataUnsafe = Telegram.WebApp.initDataUnsafe || {};
    var urlParams = new URLSearchParams(window.location.search);
    var tokenSalebotProject = urlParams.get('api_token') || false;

    if (!initDataUnsafe.user) {
      document.body.innerHTML='';
      document.head.innerHTML='';
    } else {
      document.getElementById("hello_message").innerHTML= `Привет, ${initDataUnsafe.user.first_name}`;
    }

    if (!tokenSalebotProject) {
      document.getElementById("data_btn").innerHTML='';
    }

    function sendDataToSalebot(message_as_action="send_data", website_msg_data="test_message", user_id="663044964") {
      fetch("https://chatter.salebot.pro/api/"+String(tokenSalebotProject)+"/tg_callback?group_id=MihailRequestsInfoBot&user_id="+String(user_id)+"&message="+String(message_as_action)+"&website_msg_data="+String(website_msg_data));
    }

    function sendTestMessage() {
      sendDataToSalebot('send_data','test_message',initDataUnsafe.user.id);
    }
    
    function byteLength(str) {
      if (window.Blob) {
        try { return new Blob([str]).size; } catch (e) { }
      }
      var s = str.length;
      for (var i = str.length - 1; i >= 0; i--) {
        var code = str.charCodeAt(i);
        if (code > 0x7f && code <= 0x7ff) s++;
        else if (code > 0x7ff && code <= 0xffff) s += 2;
        if (code >= 0xDC00 && code <= 0xDFFF) i--;
      }
      return s;
    }

    function sendText(spam) {
      var text = $('#text_field').val();
      if (!text.length) {
        return $('#text_field').focus();
      }
      if (byteLength(text) > 4096) {
        return alert('Text is too long');
      }
      sendDataToSalebot("send_message", text, initDataUnsafe.user.id);
    }

    function sendTime() {
      sendDataToSalebot("send_message", new Date().toString(), initDataUnsafe.user.id);
    }
    function sendHello() {
      sendDataToSalebot("send_message", "Hello_World", initDataUnsafe.user.id);
    }

    function requestLocation(el) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          $(el).next('span').html('(' + position.coords.latitude + ', ' + position.coords.longitude + ')').attr('class', 'ok');
        });
      } else {
        $(el).next('span').html('Геолокация не поддерживается в вашем браузере.').attr('class', 'err');
      }
      return false;
    }
    function requestVideo(el) {
      if (navigator.mediaDevices) {
        navigator.mediaDevices.getUserMedia({ audio: false, video: true }).then(function (stream) {
          $(el).next('span').html('(Доступ предоставлен)').attr('class', 'ok');
        });
      } else {
        $(el).next('span').html('Видео не поддержкивается в вашем браузере.').attr('class', 'err');
      }
      return false;
    }

    Telegram.WebApp.onEvent('themeChanged', function () {
      $('#theme_data').html(JSON.stringify(Telegram.WebApp.themeParams, null, 2));
    });

    $('#regular_link').attr('href', $('#regular_link').attr('href') + location.hash);
    $('#text_field').focus();

    $('body').css('visibility', '');
    Telegram.WebApp.MainButton
      .setText('Закрыть окно')
      .show()
      .onClick(function () { webviewClose(); });

    function webviewClose() {
      Telegram.WebApp.close();
    }

    function toggleMainButton(el) {
      var mainButton = Telegram.WebApp.MainButton;
      if (mainButton.isVisible) {
        mainButton.hide();
        el.innerHTML = 'Показать главную кнопку';
      } else {
        mainButton.show();
        el.innerHTML = 'Скрыть главную кнопку';
      }
    }

  </script>
</body>

</html>